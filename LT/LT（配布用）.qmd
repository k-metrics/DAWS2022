---
title: "どれが儲かる？"
subtitle: "〜つみたてNISAを可視化する〜"
# author: "CC BY-NC-SA 4.0, Sampo Suzuki"
date: "2022/6/24"
# lang: ja
format: 
  revealjs: 
    chalkboard: true
    footer: "CC BY-NC-SA 4.0, Sampo Suzuki"
    slide-number: false
    # smaller: true
    transition: slide # none, fade, slide, convex, concave, zoom
    theme: moon # beige, blood, dark, default, league, moon, night, serif, simple, sky, solarized
---

```{r}
#| include: false
source("../R/setup.R")

base_info <- "../data/sample/つみたてNISA_基本情報_2022-06-18.csv" %>% 
  read.csv() %>% 
  tidyr::separate(type, into = c("NISA", "市場", "タイプ"), sep = "/") %>% 
  dplyr::select(-NISA)

operation_info <- "../data/sample/つみたてNISA_運用情報_2022-06-18.csv" %>% 
  read.csv()

fund_data <- base_info %>% 
  dplyr::select(code, インデックス = インデックス型, 市場, タイプ) %>% 
  dplyr::left_join(operation_info, by = "code") %>% 
  dplyr::mutate(期間 = forcats::fct_inorder(期間)) %>% 
  dplyr::rename(リスク = `リスク.標準偏差.`) %>% 
  dplyr::mutate(リターン = リスク * シャープレシオ)

# palette <- "Dark2"
palette <- "Set1"
```


# はじめに

## Ｄｉｓｃｌａｉｍｅｒ

:::{.callout-important}
* 本資料は楽天証券・投資信託協会・価格コムのサイトからスクレイピングして得た情報を利用しています
    * 情報自体の著作権は原著作者にあります
    * 情報は過去の実績に基づくもので将来を保証するものではありません
* 本資料を利用したことにより生じたいかなる損害についても一切の責任は負いません
* 本資料は投資勧誘を目的にするものではありません
* 本資料での計算では手数料・管理費・配当金などは考慮していません
* 本資料で利用している**データファイルの再配布は禁止**します
* 本資料は発表用とは異なる部分があります。
:::


## 対象データ（インデックス別） {.smaller}
::: {.notes}
投信総合検索ライブラリーからスクレイピングで取得
:::
```{r}
#| echo: false
base_info %>% 
  dplyr::group_by(インデックス型, 市場, タイプ) %>%
  dplyr::summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = インデックス型, values_from = n) %>% 
  knitr::kable()
```

　  

:::{.callout-note appearance="simple"}
項目名などの詳細は投信総合検索ライブラリー（投資信託協会）で確認してください  
以降、同様
:::


## 対象データ（運用期間別） {.smaller}
::: {.notes}
3年目を超えると運用実績が減っていく
:::
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>% 
  dplyr::group_by(インデックス, 市場, タイプ, 期間) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  tidyr::pivot_wider(names_from = 期間, values_from = n) %>% 
  knitr::kable()
```


## リターンの算出（おさらい）
スクレイピングで得られる運用情報は、各期間の騰落率・リターンの標準偏差（リスク）・シャープレシオですので、  
　  

$\mbox{シャープレシオ} = \frac{\mbox{リターンの平均値} - \mbox{無リスク資産のリターン}}{\mbox{リターンの標準偏差}}$

　  
の関係を用いて、無リスク資産のリターン$= 0\%$として、リターンの平均値を算出、利用しています。

:::{.callout-note appearance="simple"}
運用情報は2022年6月中頃に取得したものです  
:::

# リスク

```{r}
#| echo: false
breaks <- seq(from = 0, to = 30, by = 2.5)
```


## リスクの分布
::: {.notes}
階級幅は2.5
:::

```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 運用期間ごとのリスクの分布
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 期間) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 市場ごとのリスクの分布
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 市場) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## インデックスによるリスクの分布
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## リスクの傾向（省略）


# リターン

```{r}
#| echo: false
breaks <- seq(from = -20, to = 20, by = 5)
# breaks <- pretty(fund_data$リターン)
```

## リターンの分布
::: {.notes}
階級幅は5
:::

```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 運用期間ごとのリターン
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 期間) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 市場ごとのリターン
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 市場) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## インデックスによるリターン
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## リターンの傾向（省略）


# リスクとリターン


## リスクとリターンの関係
::: {.notes}
斜めの点線はシャープレシオ=1の線
:::
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## 運用期間ごとのリスクとリターンの関係
::: {.notes}
運用期間が長い方ほど高シャープレシオになるが、3年から5年の間でゆる戻しが認められる
:::
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::facet_wrap(~ 期間) + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## 市場ごとのリスクとリターンの関係
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::facet_wrap(~ 市場) + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## インデックスによるリスクとリターンの関係
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## リスクとリターンの関係（省略）


# 商品分類ごとの比較

## 平均値の算出

* 市場・タイプ・インデックスの組合せを商品分類とします
* 各商品分類の期間ごとにリスクとリターン、シャープレシオの単純平均を求めます
* 求めた単純平均を用いて商品分類ごとの比較を行います

```{r}
#| echo: false
fund_mean <- fund_data %>% 
  dplyr::group_by(市場, タイプ, インデックス, 期間) %>% 
  dplyr::summarise(リスク平均 = mean(リスク, na.rm = TRUE),
                   リターン平均 = mean(リターン, na.rm = TRUE),
                   シャープレシオ平均 = mean(シャープレシオ, na.rm = TRUE)) 
```


## 平均値による比較
::: {.notes}
商品分類ごとに平均値を計算して期間による変動を可視化
:::
```{r}
#| echo: false
fund_mean %>% 
  dplyr::mutate(シャープレシオ平均 = round(シャープレシオ平均, 2),
                label = paste(期間, シャープレシオ平均, sep = "/"),
                商品分類 = paste(市場, タイプ, sep ="/")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク平均, y = リターン平均,
                               colour = 商品分類, label = label)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(shape = タイプ)) + 
    ggplot2::geom_path(linetype = "dotted") + 
    ggrepel::geom_text_repel() + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_color_brewer(palette = "Dark2")
```


## 商品（国内/資産複合）単位の比較
```{r}
#| echo: false
fund_data %>% 
  dplyr::mutate(シャープレシオ = round(シャープレシオ, 2),
                label = paste(期間, シャープレシオ, sep = "/"),
                商品分類 = paste(市場, タイプ, sep ="/")) %>% 
  dplyr::filter(商品分類 == "国内/資産複合") %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン,
                               colour = code, label = label)) + 
    ggplot2::geom_abline(slope = c(0, 0.6), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(shape = タイプ)) + 
    ggplot2::geom_path(linetype = "dotted") + 
    ggrepel::geom_text_repel() + 
    ggplot2::labs(caption = "無リスク資産のリターンを0%とした場合") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_color_brewer(palette = "Dark2")
```


# まとめ

## 全体を通して（省略）


# 参考資料

## 購入時手数料の平均値［％］ {.smaller}
```{r}
#| echo: false
base_info %>% 
  dplyr::select(市場, タイプ, インデックス型,
                購入時手数料 = `購入時手数料.上限.`,
                運用管理費用 = `運用管理費用.信託報酬.`) %>% 
  dplyr::mutate(購入時手数料 = stringr::str_remove(購入時手数料, "%"),
                購入時手数料 = stringr::str_remove(購入時手数料, "以内"),
                運用管理費用 = stringr::str_remove(運用管理費用, "%")) %>% 
  dplyr::mutate(購入時手数料 = as.numeric(購入時手数料),
                運用管理費用 = as.numeric(運用管理費用)) %>% 
  dplyr::group_by(市場, タイプ, インデックス型) %>% 
  dplyr::summarise(dplyr::across(.cols = where(is.numeric),
                                 .fns = mean, na.rm = TRUE)) %>% 
  dplyr::mutate(dplyr::across(.cols = where(is.numeric),
                              .fns = round, 2)) %>% 
  dplyr::select(-運用管理費用) %>% 
  tidyr::pivot_wider(names_from = インデックス型, values_from = 購入時手数料) %>% 
  knitr::kable()
```

　  

:::{.callout-note appearance="simple"}
一部のデータは上限値を使用しています
:::


## 運用管理費用の平均値［％］ {.smaller}
```{r}
#| echo: false
base_info %>% 
  dplyr::select(市場, タイプ, インデックス型,
                購入時手数料 = `購入時手数料.上限.`,
                運用管理費用 = `運用管理費用.信託報酬.`) %>% 
  dplyr::mutate(購入時手数料 = stringr::str_remove(購入時手数料, "%"),
                購入時手数料 = stringr::str_remove(購入時手数料, "以内"),
                運用管理費用 = stringr::str_remove(運用管理費用, "%")) %>% 
  dplyr::mutate(購入時手数料 = as.numeric(購入時手数料),
                運用管理費用 = as.numeric(運用管理費用)) %>% 
  dplyr::group_by(市場, タイプ, インデックス型) %>% 
  dplyr::summarise(dplyr::across(.cols = where(is.numeric),
                                 .fns = mean, na.rm = TRUE)) %>% 
  dplyr::mutate(dplyr::across(.cols = where(is.numeric),
                              .fns = round, 2)) %>% 
  dplyr::select(-購入時手数料) %>% 
  tidyr::pivot_wider(names_from = インデックス型, values_from = 運用管理費用) %>% 
  knitr::kable()
```


## 国債の金利［％］ {.smaller}
```{r}
#| echo: false
"../data/sample/JGBCM.csv" %>% 
  readr::read_csv(locale = readr::locale(encoding = "CP932"), skip = 1) %>% 
  dplyr::summarise(dplyr::across(.cols = where(is.numeric), .fns = mean)) %>% 
  dplyr::select(`1年`, `3年`, `5年`, `10年`, `20年`, `30年`) %>% 
  dplyr::mutate(dplyr::across(.cols = dplyr::everything(),
                              .fns = round, digits = 3)) %>% 
  knitr::kable()
```

　  

:::{.callout-note appearance="simple"}
財務省が公表している国債金利情報を元に2022年6月の各基準日の値を単純平均したものです  
1年未満のデータは公表されていません
:::


# ＥＮＪＯＹ！

