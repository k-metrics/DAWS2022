---
title: "金融商品の比較"
subtitle: "リスクとリターンの関係を可視化する"
author: "CC BY-NC-SA 4.0, Sampo Suzuki"
# lang: ja
format: 
  revealjs: 
    theme: moon # beige, blood, dark, default, league, moon, night, serif, simple, sky, solarized
---

```{r}
#| include: false
source("../R/setup.R")

base_info <- "../data/sample/つみたてNISA_基本情報_2022-06-18.csv" %>% 
  read.csv() %>% 
  tidyr::separate(type, into = c("NISA", "市場", "タイプ"), sep = "/") %>% 
  dplyr::select(-NISA)

operation_info <- "../data/sample/つみたてNISA_運用情報_2022-06-18.csv" %>% 
  read.csv()

fund_data <- base_info %>% 
  dplyr::select(code, インデックス = インデックス型, 市場, タイプ) %>% 
  dplyr::left_join(operation_info, by = "code") %>% 
  dplyr::mutate(期間 = forcats::fct_inorder(期間)) %>% 
  dplyr::rename(リスク = `リスク.標準偏差.`) %>% 
  dplyr::mutate(リターン = リスク * シャープレシオ)

# palette <- "Dark2"
palette <- "Set1"
```


# はじめに

## Ｄｉｓｃｌａｉｍｅｒ

:::{.callout-important}
* 本資料は楽天証券・投資信託協会・価格コムのサイトからスクレイピングして得た情報を利用しています
    * 情報自体の著作権は原著作者にあります
    * 情報は過去の実績に基づくもので将来を保証するものではありません
* 本資料を利用したことにより生じたいかなる損害についても一切の責任は負いません
* 本資料は投資勧誘を目的にするものではありません
* 本資料での計算では手数料・管理費・配当金などは考慮していません
* 本資料で利用している**データファイルの再配布は禁止**します
:::


## 対象データ（つみたてＮＩＳＡ）
::: {.notes}
投信総合検索ライブラリーからスクレイピングで取得
:::
```{r}
#| echo: false
base_info %>% 
  dplyr::group_by(インデックス型, 市場, タイプ) %>%
  dplyr::summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = インデックス型, values_from = n) %>% 
  df_print()
```


## リターンの算出（おさらい）
スクレイピングで得た運用情報は、各期間（6ヶ月/1年/3年/5年/10年）の騰落率（$\approx$利回り）・リターンの標準偏差（リスク）・シャープレシオのみです。  
　  

$\mbox{シャープレシオ} = \frac{\mbox{リターンの平均値} - \mbox{無リスク資産のリターン}}{\mbox{リターンの標準偏差}}$

　  
より無リスク資産のリターンを$0\%$としてリターンの平均値を求めています。

:::{.callout-note}
運用情報は2022年6月中頃のものです
:::

# リスク

```{r}
#| echo: false
breaks <- seq(from = 0, to = 30, by = 2.5)
```


## リスクの分布
::: {.notes}
階級幅は2.5
:::

```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 運用期間ごとのリスクの分布
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 期間) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 市場ごとのリスクの分布
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 市場) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## インデックスによるリスクの分布
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リスク)) %>%
  ggplot2::ggplot(ggplot2::aes(x = リスク)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## リスクの傾向

* 全体傾向
    * 株式に比べて資産複合の方がリスクが低い傾向
* 期間による傾向
    * 期間によるリスクの変化は少ない傾向
* 市場による傾向
  * 内外市場では資産複合の方がリスクが低い傾向
* インデックスによる傾向
  * 資産複合はインデックス型の方がリスクが低い傾向


# リターン

```{r}
#| echo: false
breaks <- seq(from = -20, to = 20, by = 5)
# breaks <- pretty(fund_data$リターン)
```

## リターンの分布
::: {.notes}
階級幅は5
:::

```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 運用期間ごとのリターン
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 期間) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## 市場ごとのリターン
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ 市場) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## インデックスによるリターン
```{r}
#| echo: false
fund_data %>% 
  dplyr::filter(!is.na(リターン)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リターン)) + 
    ggplot2::geom_histogram(ggplot2::aes(fill = タイプ),
                            position = "identity", alpha = 0.5,
                            breaks = breaks) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::ylab("") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_fill_brewer(palette = palette)
```


## リターンの傾向

* 全体傾向
    * 株式に比べて資産複合の方がリターンが低い傾向
    * 株式には二峰性が見られる
* 期間による傾向
    * 期間が長いほうがリターンが高くなる傾向
* 市場による傾向
  * 内外市場の大半はリターンがプラスの傾向
* インデックスによる傾向
  * 資産複合はインデックス型の方が安定傾向


# リスクとリターン


## リスクとリターンの関係
::: {.notes}
斜めの点線はシャープレシオ=1の線
:::
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## 運用期間ごとのリスクとリターンの関係
::: {.notes}
運用期間が長い方ほど高シャープレシオになるが、3年から5年の間でゆる戻しが認められる
:::
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::facet_wrap(~ 期間) + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## 市場ごとのリスクとリターンの関係
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::facet_wrap(~ 市場) + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## インデックスによるリスクとリターンの関係
```{r}
#| echo: false
fund_data %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(colour = タイプ), alpha = 0.5) + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_colour_brewer(palette = palette)
```


## リスクとリターンの関係

* 株式の方がハイリスク・ハイリターンの傾向
    * 運用期間が長くても傾向は変わらない
* 長期保有の方がシャープレシオが高くなる傾向
* 海外市場の方がハイリスクな傾向
* インデックス型の方が安定している傾向


# 商品分類ごとの比較

## 平均値の算出

* 市場・タイプの組合せを商品分類とします
* 各商品分類のインデックス型・期間ごとに運用情報の単純平均を求めます
* 求めた単純平均を用いて商品分類ごとの比較を行います

```{r}
#| echo: false
fund_mean <- fund_data %>% 
  dplyr::group_by(市場, タイプ, インデックス, 期間) %>% 
  dplyr::summarise(リスク平均 = mean(リスク, na.rm = TRUE),
                   リターン平均 = mean(リターン, na.rm = TRUE),
                   シャープレシオ平均 = mean(シャープレシオ, na.rm = TRUE)) 
```


## 平均値による比較
::: {.notes}
商品分類ごとに平均値を計算して期間による変動を可視化
:::
```{r}
#| echo: false
fund_mean %>% 
  dplyr::mutate(シャープレシオ平均 = round(シャープレシオ平均, 1),
                label = paste(期間, シャープレシオ平均, sep = "/"),
                商品分類 = paste(市場, タイプ, sep ="/")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク平均, y = リターン平均,
                               colour = 商品分類, label = label)) + 
    ggplot2::geom_abline(slope = c(0, 1), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(shape = タイプ)) + 
    ggplot2::geom_path(linetype = "dotted") + 
    ggrepel::geom_text_repel() + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_color_brewer(palette = "Dark2")
```


## 商品（国内/資産複合）単位の比較
```{r}
#| echo: false
fund_data %>% 
  dplyr::mutate(シャープレシオ = round(シャープレシオ, 1),
                label = paste(期間, シャープレシオ, sep = "/"),
                商品分類 = paste(市場, タイプ, sep ="/")) %>% 
  dplyr::filter(商品分類 == "国内/資産複合") %>% 
  ggplot2::ggplot(ggplot2::aes(x = リスク, y = リターン,
                               colour = code, label = label)) + 
    ggplot2::geom_abline(slope = c(0, 0.6), intercept = 0,
                         size = 0.2, linetype = "dashed") +
    ggplot2::geom_point(ggplot2::aes(shape = タイプ)) + 
    ggplot2::geom_path(linetype = "dotted") + 
    ggrepel::geom_text_repel() + 
    ggplot2::labs(caption = "無リスク資産の利回りを0%とした場合") + 
    ggplot2::facet_wrap(~ インデックス) + 
    ggplot2::scale_color_brewer(palette = "Dark2")
```


# まとめ

## 全体を通して
* 数値を眺めていても分からないことは可視化することで理解しやすくなることもある
    * 可視化するにも統計の基本的知識は必要
    * 加えて統計的分析ツールの知識も必要
* 世間で言われる投資の基本は実データを見るとよくわかる
* 金融商品を扱っている会社はけっこう厭らしい
    * 会社によって用語が微妙に異なっている
    * サイトはスクレイピングしにくいところが多い
    * 鴨にならないように金融リテラシーは必要


# 参考資料

## 購入時手数料の平均値［％］
```{r}
#| echo: false
base_info %>% 
  dplyr::select(市場, タイプ, インデックス型,
                購入時手数料 = `購入時手数料.上限.`,
                運用管理費用 = `運用管理費用.信託報酬.`) %>% 
  dplyr::mutate(購入時手数料 = stringr::str_remove(購入時手数料, "%"),
                購入時手数料 = stringr::str_remove(購入時手数料, "以内"),
                運用管理費用 = stringr::str_remove(運用管理費用, "%")) %>% 
  dplyr::mutate(購入時手数料 = as.numeric(購入時手数料),
                運用管理費用 = as.numeric(運用管理費用)) %>% 
  dplyr::group_by(市場, タイプ, インデックス型) %>% 
  dplyr::summarise(dplyr::across(.cols = where(is.numeric),
                                 .fns = mean, na.rm = TRUE)) %>% 
  dplyr::mutate(dplyr::across(.cols = where(is.numeric),
                              .fns = round, 2)) %>% 
  dplyr::select(-運用管理費用) %>% 
  tidyr::pivot_wider(names_from = インデックス型, values_from = 購入時手数料) %>% 
  df_print()
```


## 運用管理費用の平均値［％］
```{r}
#| echo: false
base_info %>% 
  dplyr::select(市場, タイプ, インデックス型,
                購入時手数料 = `購入時手数料.上限.`,
                運用管理費用 = `運用管理費用.信託報酬.`) %>% 
  dplyr::mutate(購入時手数料 = stringr::str_remove(購入時手数料, "%"),
                購入時手数料 = stringr::str_remove(購入時手数料, "以内"),
                運用管理費用 = stringr::str_remove(運用管理費用, "%")) %>% 
  dplyr::mutate(購入時手数料 = as.numeric(購入時手数料),
                運用管理費用 = as.numeric(運用管理費用)) %>% 
  dplyr::group_by(市場, タイプ, インデックス型) %>% 
  dplyr::summarise(dplyr::across(.cols = where(is.numeric),
                                 .fns = mean, na.rm = TRUE)) %>% 
  dplyr::mutate(dplyr::across(.cols = where(is.numeric),
                              .fns = round, 2)) %>% 
  dplyr::select(-購入時手数料) %>% 
  tidyr::pivot_wider(names_from = インデックス型, values_from = 運用管理費用) %>% 
  df_print()
```


# ＥＮＪＯＹ！

